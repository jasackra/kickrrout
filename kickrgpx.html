<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<title>Live Kickr Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body {height:100%; margin:0; padding:0; overflow:hidden; font-family: sans-serif;}
  #controls {
    position:absolute; top:10px; left:10px; z-index:1000;
    background: rgba(255,255,255,0.95); padding:12px; border-radius:8px; width:300px;
  }
  #controls input, #controls button {margin:5px 0; width:100%;}
  #info {
    position:absolute; top:10px; right:10px; z-index:1000;
    background: rgba(255,255,255,0.9); padding:10px; border-radius:8px;
    font-weight:bold; width:220px; line-height:1.4em;
  }
  #map {width:100%; height:100%;}
  #profile {
    position:absolute; bottom:0; left:0; right:0; height:120px; background:#eee; z-index:999;
  }
  canvas {width:100%; height:100%;}
  #popupOverlay {
    position:absolute; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.6); display:none; z-index:2000;
    justify-content:center; align-items:center;
  }
  #popup {
    background:#fff; padding:20px; border-radius:12px;
    width:65%; height:65%; display:flex; flex-direction:column; justify-content:center; align-items:center;
  }
  #popup h2 {margin-top:0;}
</style>
</head>
<body>

<div id="controls">
  <input type="file" id="gpxfile" accept=".gpx"/>
  <input type="number" id="weight" placeholder="Fahrergewicht (kg)" min="30" max="150"/>
  <button id="connectKickr">Kickr verbinden</button>
</div>

<div id="info">
  <div>Höhenmeter: <span id="hm">0</span> m</div>
  <div>Steigung: <span id="slope">0</span> %</div>
  <div>Leistung: <span id="power">0</span> W</div>
  <div>RPM: <span id="rpm">0</span></div>
  <div>Kadenz: <span id="cadence">0</span></div>
  <div>Distanz: <span id="dist">0</span> km</div>
  <div>Zeit: <span id="duration">00:00:00</span></div>
</div>

<div id="map"></div>
<div id="profile"><canvas id="elevationCanvas"></canvas></div>
<div id="popupOverlay"><div id="popup"><h2>Gesamtwerte</h2><div id="summary"></div></div></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

<script>
let map = L.map('map').setView([51.5,10],6);
let osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OSM contributors'}).addTo(map);

let routeLine=null, marker=null, coords=[], elevations=[];
let totalGain=0, idx=0, startTime=null, distanceTravelled=0;

const g=9.81;
const canvas = document.getElementById("elevationCanvas");
const ctx = canvas.getContext("2d");

let kickrDevice=null, kickrServer=null, kickrCharacteristic=null;
let currentRPM=0, currentCadence=0, currentPower=0;

// GPX laden
document.getElementById('gpxfile').addEventListener('change', e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=evt=>{
    const gpxDoc = new DOMParser().parseFromString(evt.target.result,"application/xml");
    const geo = toGeoJSON.gpx(gpxDoc);
    const feature = geo.features.find(f=>f.geometry?.type==="LineString");
    if(!feature){alert("Keine Trackdaten gefunden."); return;}
    coords = feature.geometry.coordinates.map(c=>[c[1],c[0]]);
    elevations = feature.geometry.coordinates.map(c=>c[2]||0);
    totalGain=0; idx=0; distanceTravelled=0;
    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.polyline(coords,{color:'#00aaff',weight:4}).addTo(map);
    map.fitBounds(routeLine.getBounds());
    if(marker) map.removeLayer(marker);
    marker=L.marker(coords[0]).addTo(map);
    startTime = new Date();
    drawProfile();
  };
  reader.readAsText(file);
});

// Höhenprofil
function drawProfile(){
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  ctx.fillStyle="#ccc";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="#00f";
  ctx.beginPath();
  elevations.forEach((h,i)=>{
    const x = (i/(elevations.length-1))*canvas.width;
    const y = canvas.height - (h/Math.max(...elevations))*canvas.height;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

// Kickr verbinden
document.getElementById('connectKickr').addEventListener('click', async ()=>{
  try{
    kickrDevice = await navigator.bluetooth.requestDevice({filters:[{namePrefix:'KICKR'}], optionalServices:['fitness_machine']});
    kickrServer = await kickrDevice.gatt.connect();
    alert("Kickr verbunden!");
  }catch(e){alert("Kickr Verbindung fehlgeschlagen"); console.error(e);}
});

// Marker aktualisieren
function updateMarker(){
  if(!coords[idx] || !coords[idx+1]) return;
  marker.setLatLng(coords[idx]);
  map.setView(coords[idx]);
  const h1 = elevations[idx], h2 = elevations[idx+1];
  const dist = haversine(coords[idx][0],coords[idx][1],coords[idx+1][0],coords[idx+1][1]);
  distanceTravelled += dist/1000;
  const slope = dist>0 ? ((h2-h1)/dist)*100 : 0;
  if(h2>h1) totalGain += (h2-h1);
  const weight = parseFloat(document.getElementById('weight').value)||75;
  const power = Math.max(0, weight*g*5.56*(slope/100));
  document.getElementById('slope').textContent = slope.toFixed(1);
  document.getElementById('hm').textContent = totalGain.toFixed(0);
  document.getElementById('power').textContent = currentPower || power.toFixed(0);
  document.getElementById('rpm').textContent = currentRPM.toFixed(0);
  document.getElementById('cadence').textContent = currentCadence.toFixed(0);
  document.getElementById('dist').textContent = distanceTravelled.toFixed(2);
  const elapsed = new Date()-startTime;
  document.getElementById('duration').textContent = new Date(elapsed).toISOString().substr(11,8);
  drawCursor();
}

// Cursor auf Profil
function drawCursor(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#ccc";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="#00f";
  ctx.beginPath();
  elevations.forEach((h,i)=>{
    const x = (i/(elevations.length-1))*canvas.width;
    const y = canvas.height - (h/Math.max(...elevations))*canvas.height;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  // Cursor
  const cursorX = (idx/(elevations.length-1))*canvas.width;
  ctx.strokeStyle="#f00"; ctx.beginPath();
  ctx.moveTo(cursorX,0); ctx.lineTo(cursorX,canvas.height); ctx.stroke();
}

// Haversine
function haversine(lat1,lon1,lat2,lon2){
  const R=6371000,toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

// Echtzeit Simulation über RPM
setInterval(()=>{
  if(currentRPM>5 && idx<coords.length-1){ idx++; updateMarker(); }
  else if(currentRPM<=5 && idx>0){ 
    setTimeout(()=>{showPopup();},10000); 
  }
},200);

// Popup
function showPopup(){
  if(document.getElementById('popupOverlay').style.display==='flex') return;
  const s = `<p>Höhenmeter: ${totalGain.toFixed(0)} m</p>
  <p>Distanz: ${distanceTravelled.toFixed(2)} km</p>
  <p>Zeit: ${document.getElementById('duration').textContent}</p>
  <p>Watt: ${document.getElementById('power').textContent}</p>`;
  document.getElementById('summary').innerHTML=s;
  document.getElementById('popupOverlay').style.display='flex';
}

// Resize
window.addEventListener('resize',()=>{ map.invalidateSize(); drawProfile(); });
</script>

</body>
</html>
