<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<title>GPX Tracker – Live & Vollbild</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body {height:100%; margin:0; padding:0; overflow:hidden; font-family: 'Segoe UI', sans-serif;}
#map {width:100%; height:100%;}

#controls {
  position:absolute; top:10px; left:10px; z-index:1000;
  background:rgba(255,255,255,0.9); padding:12px; border-radius:8px;
  display:flex; flex-direction: column; gap:6px; width: 220px;
}
#controls input, #controls button {padding:6px; font-size:14px;}
#fullscreenBtn {margin-top:6px;}

#infobar {
  position:absolute; top:10px; left:250px; z-index:1000;
  background:rgba(0,0,0,0.7); color:#fff; padding:10px 14px;
  border-radius:8px; font-size:14px; line-height:1.4em;
  display:flex; flex-direction: column; gap:4px; min-width:180px;
}

#elevation {
  position:absolute; bottom:10px; left:10px; right:10px; height:120px; z-index:1000;
  background:#e0e0e0; border-radius:6px; padding:6px;
}

#elevation canvas {width:100%; height:100%;}
</style>
</head>
<body>

<div id="controls">
  <input type="file" id="gpxfile" accept=".gpx"/>
  <label>Fahrergewicht (kg): <input type="number" id="weight" value="75" min="30" max="150"/></label>
  <button id="fullscreenBtn">⛶ Vollbild</button>
</div>

<div id="infobar">
  <div>Dauer: <span id="duration">0:00</span></div>
  <div>Distanz: <span id="distance">0</span> km</div>
  <div>Höhenmeter: <span id="hm">0</span> m</div>
  <div>Steigung: <span id="slope">0</span> %</div>
  <div>Leistung: <span id="power">0</span> W</div>
  <div>Kadenz: <span id="cadence">0</span> rpm</div>
</div>

<div id="map"></div>
<div id="elevation"><canvas id="elevCanvas"></canvas></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
<script>
let map = L.map('map').setView([51.5,10],6);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

let routeLine=null, marker=null, coords=[], elevations=[];
let totalGain=0, idx=0, startTime=null;
let canvas = document.getElementById('elevCanvas');
let ctx = canvas.getContext('2d');

function resizeCanvas(){ canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
window.addEventListener('resize', ()=>{ resizeCanvas(); map.invalidateSize(); drawProfile(); });
resizeCanvas();

document.getElementById('gpxfile').addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = evt=>{
    try {
      const gpxDoc = new DOMParser().parseFromString(evt.target.result,"application/xml");
      const geo = toGeoJSON.gpx(gpxDoc);
      const feature = geo.features.find(f=>f.geometry?.type==="LineString");
      if(!feature){alert("Keine Trackdaten gefunden."); return;}
      coords = feature.geometry.coordinates.map(c=>[c[1],c[0]]);
      elevations = feature.geometry.coordinates.map(c=>c[2]||0);
      totalGain=0; idx=0; startTime = Date.now();

      if(routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline(coords,{color:'#00aaff', weight:4}).addTo(map);
      map.fitBounds(routeLine.getBounds());

      if(marker) map.removeLayer(marker);
      marker = L.marker(coords[0]).addTo(map);

      ['hm','slope','power','distance','duration','cadence'].forEach(id=>document.getElementById(id).textContent="0");
      drawProfile();
    } catch(err){ console.error(err); alert("Fehler beim Laden der GPX-Datei."); }
  };
  reader.readAsText(file);
});

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000, toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

function drawProfile(){
  if(!coords.length) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#d3d3d3"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="#0066cc"; ctx.lineWidth=2;
  ctx.beginPath();
  const maxH = Math.max(...elevations), minH = Math.min(...elevations);
  coords.forEach((c,i)=>{
    const x = (i/coords.length)*canvas.width;
    const y = canvas.height - ((elevations[i]-minH)/(maxH-minH)*canvas.height);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

function updateMarker(i, cadence=60){
  if(!coords[i] || !coords[i+1]) return;
  marker.setLatLng(coords[i]);
  map.setView(coords[i], map.getZoom());
  const h1 = elevations[i], h2 = elevations[i+1];
  const dist = haversine(coords[i][0],coords[i][1],coords[i+1][0],coords[i+1][1])/1000; // km
  const slope = dist>0?((h2-h1)/1000)/dist*100:0;
  if(h2>h1) totalGain += (h2-h1);
  const weight = parseFloat(document.getElementById('weight').value)||75;
  const power = Math.max(0, weight*9.81*2.78*(slope/100));

  document.getElementById('hm').textContent = totalGain.toFixed(0);
  document.getElementById('slope').textContent = slope.toFixed(1);
  document.getElementById('power').textContent = power.toFixed(0);
  document.getElementById('distance').textContent = dist.toFixed(2);
  const sec = Math.floor((Date.now()-startTime)/1000);
  document.getElementById('duration').textContent = `${Math.floor(sec/60)}:${(sec%60).toString().padStart(2,'0')}`;
  document.getElementById('cadence').textContent = cadence;
  
  drawProfile();
}

document.getElementById('fullscreenBtn').addEventListener('click', ()=>{
  const el = document.getElementById('map');
  if(!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.();
});

// Dummy für Live-Daten vom Kickr
setInterval(()=>{
  if(!coords.length) return;
  idx = (idx+1)%coords.length;
  updateMarker(idx, 70 + Math.floor(Math.random()*10));
},500);

</script>
</body>
</html>
