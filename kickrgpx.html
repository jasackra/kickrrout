<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<title>Kickr Live Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body {height:100%; margin:0; padding:0; overflow:hidden;}
#map {width:100%; height:100vh; z-index:1;}
#controls {
  position:absolute; top:10px; left:10px; z-index:1001;
  background: rgba(255,255,255,0.85); padding:10px; border-radius:8px;
}
#controls input, #controls button {margin-top:4px; display:block;}
#themeBtn, #fullscreenBtn, #connectBtn {
  background:#222; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:bold;
}
#themeBtn.light {background:#eee; color:#222;}
#stats {
  position:absolute; bottom:15px; left:15px; z-index:1001;
  background:rgba(0,0,0,0.7); color:#fff; font-family:sans-serif;
  padding:8px 12px; border-radius:8px; font-size:14px; line-height:1.4em;
}
</style>
</head>
<body>

<div id="controls">
  Fahrergewicht (kg): <input type="number" id="weight" value="75" min="30" max="150"/>
  <button id="themeBtn" class="light">ðŸŒž Tag</button>
  <button id="fullscreenBtn">â›¶ Vollbild</button>
  <button id="connectBtn">ðŸ”— KICKR CORE verbinden</button>
</div>

<div id="stats">
  Distanz: <span id="distance">0</span> km<br>
  Zeit: <span id="time">0:00</span><br>
  HÃ¶henmeter: <span id="hm">0</span> m<br>
  Steigung: <span id="slope">0</span> %<br>
  Leistung: <span id="power">0</span> W<br>
  Kadenz: <span id="cadence">0</span> rpm
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map = L.map('map').setView([51.5, 10],6);

// Tile Layers
const osmLight = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap contributors'});
const osmDark = L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {maxZoom:20, attribution:'&copy; OpenStreetMap & Stadia Maps'});
let currentLayer = osmLight.addTo(map);
let darkMode = false;

// Theme toggle
document.getElementById('themeBtn').addEventListener('click', () => {
  map.removeLayer(currentLayer);
  const btn = document.getElementById('themeBtn');
  if (darkMode) { currentLayer = osmLight.addTo(map); btn.textContent="ðŸŒž Tag"; btn.classList.add("light"); darkMode=false; }
  else { currentLayer = osmDark.addTo(map); btn.textContent="ðŸŒ™ Nacht"; btn.classList.remove("light"); darkMode=true; }
});

// Fullscreen
document.getElementById('fullscreenBtn').addEventListener('click', () => {
  const el = document.getElementById('map');
  if (!document.fullscreenElement) { if(el.requestFullscreen) el.requestFullscreen(); }
  else { if(document.exitFullscreen) document.exitFullscreen(); }
});

// Marker + Stats
let marker=null, totalGain=0, distance=0, startTime=null, timer=null;
const g=9.81;
let weight = parseFloat(document.getElementById('weight').value)||75;

function updateStats(lat, lon, elev, cad, power, dist){
  if(!marker) marker = L.marker([lat, lon]).addTo(map);
  marker.setLatLng([lat, lon]);
  map.setView([lat, lon], map.getZoom(), {animate:true, duration:0.25});
  document.getElementById('power').textContent = Math.round(power);
  document.getElementById('cadence').textContent = Math.round(cad);
  document.getElementById('distance').textContent = (dist/1000).toFixed(2);
  totalGain = elev>0?elev:0;
  document.getElementById('hm').textContent = Math.round(totalGain);
}

function formatTime(ms){ let s=Math.floor(ms/1000); let m=Math.floor(s/60); s=s%60; return m+":"+String(s).padStart(2,'0'); }
function updateTime(){ if(startTime) document.getElementById('time').textContent=formatTime(Date.now()-startTime); }

// KICKR Connect
document.getElementById('connectBtn').addEventListener('click', async ()=>{
  try{
    const device = await navigator.bluetooth.requestDevice({filters:[{namePrefix:"KICKR"}], optionalServices:[0x1816,0x1818]});
    const server = await device.gatt.connect();
    alert("KICKR CORE verbunden!");
    startTime=Date.now();
    timer=setInterval(updateTime,1000);
    // Hier KICKR-Daten auslesen â†’ updateStats(lat, lon, elev, cad, power, distance)
  }catch(e){console.error(e); alert("Verbindung fehlgeschlagen: "+e);}
});

// Resize fix
window.addEventListener('resize',()=>{map.invalidateSize();});
</script>

</body>
</html>
