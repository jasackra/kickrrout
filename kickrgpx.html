<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>GPX Kickr Live & Sim Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body {margin:0; padding:0; height:100%; overflow:hidden; background:#f0f0f0;}
#map {width:100%; height:100%; position:absolute; top:0; left:0; z-index:1;}
#topbar {
  position:fixed; top:0; left:0; width:100%;
  background:rgba(255,255,255,0.85); color:#000;
  z-index:1000; padding:10px;
  font-family:sans-serif; font-size:14px;
  display:flex; justify-content:space-around; align-items:center;
}
#controls {
  position:fixed; bottom:10px; left:50%; transform:translateX(-50%);
  background:rgba(255,255,255,0.85); color:#000;
  padding:6px 10px; border-radius:10px;
  display:flex; gap:10px; z-index:1000;
  font-family:sans-serif; font-size:13px;
}
#controls button, #controls input {
  border:none; border-radius:6px;
  padding:5px 8px; cursor:pointer; font-size:13px;
  background:#eee; color:#000;
}
#connectBtn.connected {background:#1aa01a; color:#fff;}
#gpxfile {display:none;}
</style>
</head>
<body>

<div id="topbar">
  <span>Distanz: <b id="dist">0.00 km</b></span>
  <span>Zeit: <b id="time">00:00</b></span>
  <span>Watt: <b id="power">0</b></span>
  <span>HM: <b id="hm">0</b></span>
  <span>Steigung: <b id="slope">0%</b></span>
  <span>Kadenz: <b id="cadence">0</b></span>
</div>

<div id="controls">
  <button id="connectBtn">üîó KICKR verbinden</button>
  <button id="gpxBtn">üìÅ GPX laden</button>
  <input type="file" id="gpxfile" accept=".gpx">
  Gewicht: <input type="number" id="weight" value="" min="40" max="150" style="width:60px;" placeholder="kg">
  <button id="fullscreenBtn">‚õ∂</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
<script>
let map = L.map('map').setView([51.5,10],7);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'&copy; OpenStreetMap'
}).addTo(map);

let coords=[], elevations=[], routeLine=null, marker=null;
let totalGain=0, distance_m=0, seconds=0, timerInt=null;
let follow=true, i=0, lastMove=Date.now(), paused=false;

// GPX laden
const fileInput=document.getElementById('gpxfile');
document.getElementById('gpxBtn').addEventListener('click',()=>{
  const weight=document.getElementById('weight').value;
  if(!weight){alert("Bitte Gewicht eingeben!"); return;}
  fileInput.click();
});
fileInput.addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=evt=>{
    const xml=new DOMParser().parseFromString(evt.target.result,"text/xml");
    const geo=toGeoJSON.gpx(xml);
    const feat=geo.features.find(f=>f.geometry?.type==="LineString");
    if(!feat){alert("Keine Strecke gefunden!");return;}
    coords=feat.geometry.coordinates.map(c=>[c[1],c[0]]);
    elevations=feat.geometry.coordinates.map(c=>c[2]||0);
    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.polyline(coords,{color:'#00aaff',weight:4}).addTo(map);
    map.fitBounds(routeLine.getBounds());
    if(marker) map.removeLayer(marker);
    marker=L.marker(coords[0]).addTo(map);
    totalGain=0; distance_m=0; seconds=0; i=0; paused=false;
    updateTopBar();
    alert("GPX geladen und Fahrt bereit!");
  };
  reader.readAsText(file);
});

// Timer
function startTimer(){
  if(timerInt) clearInterval(timerInt);
  timerInt=setInterval(()=>{
    if(!paused) seconds++;
    const m=Math.floor(seconds/60), s=seconds%60;
    document.getElementById('time').textContent=
      `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  },1000);
}
startTimer();

// Vollbild
document.getElementById('fullscreenBtn').addEventListener('click',()=>{
  const el=document.documentElement;
  if(!document.fullscreenElement){el.requestFullscreen();}
  else document.exitFullscreen();
});

// Web Bluetooth KICKR verbinden & Sim Modus
let kickrDevice=null, kickrServer=null, cyclingService=null;
document.getElementById('connectBtn').addEventListener('click',async()=>{
  const btn=document.getElementById('connectBtn');
  if(btn.classList.contains('connected')){
    btn.classList.remove('connected'); btn.textContent='üîó KICKR verbinden';
    if(kickrDevice && kickrDevice.gatt.connected) kickrDevice.gatt.disconnect();
  }else{
    try{
      kickrDevice = await navigator.bluetooth.requestDevice({
        filters:[{namePrefix:'KICKR'}],
        optionalServices:['cycling_power','fitness_machine']
      });
      kickrServer = await kickrDevice.gatt.connect();
      btn.classList.add('connected'); btn.textContent='‚úÖ KICKR verbunden';
      cyclingService = await kickrServer.getPrimaryService('cycling_power');
      // Simulation & Characteristic abonnieren hier
    }catch(err){alert("Verbindung fehlgeschlagen: "+err);}
  }
});

// Marker & Werte Live-Update
setInterval(async()=>{
  if(!coords.length || !marker) return;
  marker.setLatLng(coords[i]);
  if(follow) map.setView(coords[i]);
  if(i>0){
    const prev=coords[i-1], curr=coords[i];
    const dist=haversine(prev[0],prev[1],curr[0],curr[1]);
    distance_m+=dist;
    const h1=elevations[i-1], h2=elevations[i];
    if(h2>h1) totalGain+=(h2-h1);
  }
  // KICKR Daten abrufen & Widerstand nach Track-Slope setzen
  if(kickrDevice && kickrDevice.gatt.connected){
    // Hier echte Werte lesen und Widerstand schreiben
    // document.getElementById('power').textContent = Watt
    // document.getElementById('cadence').textContent = Kadenz
    // document.getElementById('slope').textContent = Track-Steigung
  }
  updateTopBar();
  lastMove=Date.now();
  if(i<coords.length-1) i++;
},500);

// Pause-Abfrage nach 10 Sekunden Stillstand
setInterval(()=>{
  if(Date.now()-lastMove>10000 && !paused && coords.length){
    paused=true;
    if(confirm("Pause erkannt. Willst du die Fahrt beenden?")){
      alert(`Gesamt: ${(distance_m/1000).toFixed(2)} km, ${totalGain.toFixed(0)} HM, Zeit: ${Math.floor(seconds/60)}:${seconds%60}`);
      distance_m=0; totalGain=0; seconds=0; i=0; paused=false;
      updateTopBar();
    }else{paused=false; lastMove=Date.now();}
  }
},1000);

function updateTopBar(){
  document.getElementById('dist').textContent=(distance_m/1000).toFixed(2)+" km";
  document.getElementById('hm').textContent=totalGain.toFixed(0);
  // Echte Werte vom KICKR einsetzen:
  // document.getElementById('power').textContent = Watt;
  // document.getElementById('cadence').textContent = Kadenz;
  // document.getElementById('slope').textContent = Steigung;
}

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000,toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+
           Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
</script>
</body>
</html>
