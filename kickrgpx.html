<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Kickr Live Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html,body{margin:0;padding:0;height:100%;width:100%;overflow:hidden;background:#000;}
#map{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;}
#modalOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:3000;display:flex;justify-content:center;align-items:center;}
#modalContent{background:#fff;border-radius:12px;padding:20px;width:320px;display:flex;flex-direction:column;gap:12px;font-family:sans-serif;text-align:center;box-shadow:0 6px 20px rgba(0,0,0,0.35);}
#modalContent input,#modalContent button{padding:6px 10px;border:none;border-radius:6px;font-size:13px;cursor:pointer;}
#modalContent button{background:#4facfe;color:#fff;font-weight:600;}
#infobar{position:fixed;top:10px;left:10px;right:10px;margin:0 auto;background: linear-gradient(135deg, #4facfe, #00f2fe); color:#fff; padding:14px 20px; border-radius:14px; z-index:1000; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight:600; font-size:14px; display:flex; flex-direction:column; gap:6px; box-shadow:0 6px 20px rgba(0,0,0,0.35);}
#infobar span{display:flex; gap:20px; justify-content:flex-start; align-items:center;}
#infobar span b{font-weight:700;}
#elevChart{position:fixed; bottom:0; left:0; width:100%; height:15%; background:#888; z-index:900; border-top:2px solid #000;}
#popupSummary{position:fixed; top:15%; left:50%; transform:translateX(-50%); width:66%; height:auto; background: rgba(255,255,255,0.95); color:#000; z-index:2000; padding:20px; border-radius:12px; font-family:sans-serif; font-size:16px; display:none; text-align:center; box-shadow: 0 6px 20px rgba(0,0,0,0.35);}
#popupSummary button{margin-top:15px; padding:6px 12px; border:none; border-radius:8px; background:#4facfe; color:#fff; cursor:pointer; font-weight:600;}
</style>
</head>
<body>

<div id="modalOverlay">
  <div id="modalContent">
    <h3>Startparameter</h3>
    <button id="gpxBtn">üìÅ GPX laden</button>
    <input type="file" id="gpxfile" accept=".gpx" style="display:none;">
    <input type="number" id="weight" placeholder="Gewicht (kg)" style="display:none;">
    <button id="connectBtn" style="display:none;">üîó KICKR verbinden</button>
  </div>
</div>

<div id="infobar">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div>
      <span><b>Distanz:</b> <span id="dist">0.00 km</span></span>
      <span><b>Zeit:</b> <span id="time">00:00</span></span>
      <span><b>HM:</b> <span id="hm">0</span></span>
    </div>
    <button id="fullscreenBtn" style="background:#222;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:bold;margin-left:10px;">‚õ∂ Vollbild</button>
  </div>
  <div style="margin-top:6px;">
    <span><b>Watt:</b> <span id="power">0</span></span>
    <span><b>Kadenz:</b> <span id="cadence">0</span></span>
    <span><b>Steigung:</b> <span id="slope">0%</span></span>
  </div>
</div>

<div id="map"></div>
<canvas id="elevChart"></canvas>
<div id="popupSummary"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
<script>
// --- Map Setup ---
let map=L.map('map').setView([51.5,10],7);
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);

// --- Variables ---
let coords=[], elevations=[], routeLine=null, marker=null;
let totalGain=0, distance_m=0, seconds=0;
let i=0, paused=false, follow=true;
let weight=0, kickrConnected=false;
let currentCadence=0, currentWatt=0;
let rpmTimeout=null;
let lastTime=Date.now();

// --- DOM Elements ---
const fileInput=document.getElementById('gpxfile');
const gpxBtn=document.getElementById('gpxBtn');
const weightInput=document.getElementById('weight');
const connectBtn=document.getElementById('connectBtn');
const popupSummary=document.getElementById('popupSummary');
const elevCanvas=document.getElementById('elevChart');
const elevCtx=elevCanvas.getContext('2d');
const modalOverlay=document.getElementById('modalOverlay');

// --- Elevation Chart ---
function drawElevationChart(){
  elevCanvas.width=window.innerWidth;
  elevCanvas.height=window.innerHeight*0.15;
  elevCtx.clearRect(0,0,elevCanvas.width,elevCanvas.height);
  if(!elevations.length) return;
  elevCtx.fillStyle='#888';
  elevCtx.fillRect(0,0,elevCanvas.width,elevCanvas.height);
  elevCtx.strokeStyle='blue';
  elevCtx.lineWidth=2;
  elevCtx.beginPath();
  const maxH=Math.max(...elevations), minH=Math.min(...elevations);
  for(let j=0;j<elevations.length;j++){
    const x=j*(elevCanvas.width/coords.length);
    const y=elevCanvas.height-( (elevations[j]-minH)/(maxH-minH) * elevCanvas.height );
    if(j===0) elevCtx.moveTo(x,y); else elevCtx.lineTo(x,y);
  }
  elevCtx.stroke();
}
function updateElevationCursor(idx){
  drawElevationChart();
  if(!coords.length) return;
  elevCtx.strokeStyle='red';
  elevCtx.lineWidth=2;
  const x=idx*(elevCanvas.width/coords.length);
  elevCtx.beginPath();
  elevCtx.moveTo(x,0);
  elevCtx.lineTo(x,elevCanvas.height);
  elevCtx.stroke();
}

// --- Modal Flow ---
gpxBtn.addEventListener('click',()=>{ fileInput.click(); });
fileInput.addEventListener('change', e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=evt=>{
    try{
      const xml=new DOMParser().parseFromString(evt.target.result,"application/xml");
      const geo=toGeoJSON.gpx(xml);
      const feat=geo.features.find(f=>f.geometry?.type==="LineString");
      if(!feat){alert("Keine Strecke gefunden!"); return;}
      coords=feat.geometry.coordinates.map(c=>[c[1],c[0]]);
      elevations=feat.geometry.coordinates.map(c=>c[2]||0);
      totalGain=0; i=0; distance_m=0; seconds=0;
      if(routeLine) map.removeLayer(routeLine);
      routeLine=L.polyline(coords,{color:'#00aaff', weight:4}).addTo(map);
      if(marker) map.removeLayer(marker);
      marker=L.marker(coords[0]).addTo(map);
      map.fitBounds(routeLine.getBounds());
      drawElevationChart();
      weightInput.style.display='inline-block';
    }catch(err){console.error(err); alert("Fehler beim Laden der GPX-Datei.");}
  };
  reader.readAsText(file);
});

weightInput.addEventListener('input',()=>{
  if(weightInput.value>0){ weight=parseFloat(weightInput.value); connectBtn.style.display='inline-block'; }
});

// --- Kickr Live Verbindung ---
connectBtn.addEventListener('click', async ()=>{
  if(!navigator.bluetooth){alert("Web Bluetooth nicht verf√ºgbar!"); return;}
  try{
    const device = await navigator.bluetooth.requestDevice({
      filters:[{namePrefix:"KICKR"}],
      optionalServices:[0x1826,0x2a63]
    });
    const server=await device.gatt.connect();
    kickrConnected=true;
    connectBtn.textContent="KICKR verbunden";
    modalOverlay.style.display='none';

    const cadenceService=await server.getPrimaryService('00001816-0000-1000-8000-00805f9b34fb'); 
    const cadenceChar=await cadenceService.getCharacteristic('00002a5b-0000-1000-8000-00805f9b34fb');
    await cadenceChar.startNotifications();
    cadenceChar.addEventListener('characteristicvaluechanged', e=>{
      const val=e.target.value.getUint16(0,true);
      currentCadence=val;
      updateTopBar();
      updateMarkerByCadence(val);
    });

    setInterval(()=>{
      if(currentCadence<5 && !paused && kickrConnected){
        paused=true;
        const confirmEnd=confirm("Fahrt unterbrochen. Beenden?");
        if(confirmEnd){showSummary();}
        else paused=false;
      }
    },10000);

  }catch(err){console.error(err); alert("Kickr Verbindung fehlgeschlagen.");}
});

// --- Marker/Map ---
function updateMarkerByCadence(cad){
  if(!coords.length || i>=coords.length) return;
  marker.setLatLng(coords[i]);
  if(follow) map.setView(coords[i], map.getZoom(), {animate:true, duration:0.2});
  const h1=elevations[i], h2=elevations[i+1]||h1;
  distance_m+=1; 
  const slope=(h2-h1)/1*100; 
  totalGain+=Math.max(0,h2-h1);
  currentWatt=(weight*9.81*cad*(slope/100))||0;
  updateElevationCursor(i);
  updateTopBar();
  i++;
  seconds=Math.floor((Date.now()-lastTime)/1000);
}

// --- Popup Summary ---
function showSummary(){
  popupSummary.style.display='block';
  popupSummary.innerHTML=`
    <h3>Fahrzusammenfassung</h3>
    <p>Distanz: ${(distance_m/1000).toFixed(2)} km</p>
    <p>Zeit: ${Math.floor(seconds/60)}:${seconds%60}</p>
    <p>H√∂henmeter: ${Math.round(totalGain)}</p>
    <p>Watt: ${Math.round(currentWatt)}</p>
    <p>Kadenz: ${Math.round(currentCadence)}</p>
    <button onclick="popupSummary.style.display='none';">Schlie√üen</button>
  `;
}

// --- Fullscreen ---
document.getElementById('fullscreenBtn').addEventListener('click',()=>{
  const el=document.documentElement;
  if(!document.fullscreenElement) el.requestFullscreen();
  else document.exitFullscreen();
});
document.addEventListener('fullscreenchange', () => { setTimeout(()=>map.invalidateSize(),100); });

// --- Infobar Update ---
function updateTopBar(){
  document.getElementById('dist').textContent=(distance_m/1000).toFixed(2);
  document.getElementById('hm').textContent=Math.round(totalGain);
  document.getElementById('cadence').textContent=Math.round(currentCadence);
  document.getElementById('power').textContent=Math.round(currentWatt);
  document.getElementById('time').textContent=`${Math.floor(seconds/60)}:${seconds%60}`;
}
</script>
</body>
</html>
