<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<title>GPX Tracker Live mit Kickr</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body {height:100%; margin:0; padding:0; overflow:hidden; font-family:sans-serif;}
#map {width:100%; height:100%;}

#controls {
  position:absolute; top:10px; left:10px; z-index:1000;
  display:flex; gap:10px;
}

#mandatory {
  display:flex; flex-direction:column; gap:6px;
  background:rgba(255,255,255,0.95); padding:12px; border-radius:8px;
}

#infobalken {
  display:flex; flex-direction:column; justify-content:center;
  background:#222; color:#fff; padding:8px 12px; border-radius:8px;
  font-size:14px; line-height:1.4em;
}

#elevation {
  position:absolute; bottom:10px; left:10px; right:10px; height:120px;
  background:#ccc; border-radius:6px; padding:6px; z-index:1001;
}
#elevation canvas {width:100%; height:100%;}

#fullscreenBtn {
  position:absolute; top:10px; right:10px; z-index:1000;
  background:#444; color:#fff; border:none; padding:6px 10px;
  border-radius:6px; cursor:pointer; font-weight:bold;
}
</style>
</head>
<body>

<div id="controls">
  <div id="mandatory">
    <input type="file" id="gpxfile" accept=".gpx"/>
    Fahrergewicht (kg): <input type="number" id="weight" value="75" min="30" max="150"/>
    <button id="kickrBtn">Kickr koppeln</button>
  </div>
  <div id="infobalken">
    Höhenmeter: <span id="hm">0</span> m
    Steigung: <span id="slope">0</span> %
    Leistung: <span id="power">0</span> W
    Kadenz: <span id="cadence">0</span> rpm
    Distanz: <span id="distance">0</span> km
    Zeit: <span id="time">00:00</span>
    Kalorien: <span id="calories">0</span> kcal
  </div>
</div>

<div id="map"></div>
<div id="elevation"><canvas id="elevationCanvas"></canvas></div>
<button id="fullscreenBtn">⛶ Vollbild</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

<script>
// Leaflet Map
let map = L.map('map').setView([51.5,10],6);
const osmLight = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'&copy; OpenStreetMap'
}).addTo(map);

// Daten
let coords=[], elevations=[], totalGain=0, distance=0;
let marker=null, idx=0, startTime=null, cadence=0, rpm=0;
let playInterval=null;
const g=9.81, v=5.56;
const ctx = document.getElementById('elevationCanvas').getContext('2d');

// GPX laden
document.getElementById('gpxfile').addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = evt=>{
    const gpxDoc = new DOMParser().parseFromString(evt.target.result,"application/xml");
    const geo = toGeoJSON.gpx(gpxDoc);
    const feature = geo.features.find(f=>f.geometry?.type==="LineString");
    if(!feature){alert("Keine Trackdaten."); return;}
    
    coords = feature.geometry.coordinates.map(c=>[c[1],c[0]]);
    elevations = feature.geometry.coordinates.map(c=>c[2]||0);
    totalGain=distance=idx=0; startTime=new Date();
    
    if(marker) map.removeLayer(marker);
    marker = L.marker(coords[0]).addTo(map);
    
    map.fitBounds(L.polyline(coords).getBounds());
    
    ['hm','slope','power','cadence','distance','time','calories'].forEach(id=>document.getElementById(id).textContent="0");
    drawProfile();
  };
  reader.readAsText(file);
});

// Höhenprofil
function drawProfile(){
  if(!coords.length) return;
  const canvas = document.getElementById('elevationCanvas');
  canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#ccc"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="#00aaff"; ctx.lineWidth=3;
  ctx.beginPath();
  const maxH = Math.max(...elevations), minH=Math.min(...elevations);
  coords.forEach((c,i)=>{
    const x=(i/coords.length)*canvas.width;
    const y=canvas.height - ((elevations[i]-minH)/(maxH-minH)*canvas.height);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

// Vollbild
document.getElementById('fullscreenBtn').addEventListener('click', ()=>{
  const el=document.getElementById('map');
  if(!document.fullscreenElement){if(el.requestFullscreen) el.requestFullscreen();}
  else if(document.exitFullscreen) document.exitFullscreen();
});

// Kickr koppeln
document.getElementById('kickrBtn').addEventListener('click', async ()=>{
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters:[{namePrefix:"KICKR"}],
      optionalServices:["fitness_machine"]
    });
    alert("Kickr verbunden: "+device.name);
    // Hier kann echte FTMS Steuerung eingebaut werden
    startSimulation();
  } catch(e){console.error(e); alert("Kickr Verbindung fehlgeschlagen");}
});

// Simulation/FTMS Live
function startSimulation(){
  if(playInterval) clearInterval(playInterval);
  playInterval = setInterval(()=>{
    if(idx>=coords.length-1){clearInterval(playInterval); return;}
    rpm = Math.random()*100+50; // Demo RPM, später vom Kickr
    cadence = rpm;
    distance += 0.01; // Demo km
    const h1=elevations[idx], h2=elevations[idx+1];
    const dist = haversine(coords[idx][0],coords[idx][1],coords[idx+1][0],coords[idx+1][1]);
    const slope = dist>0?((h2-h1)/dist)*100:0;
    if(h2>h1) totalGain += (h2-h1);
    const weight=parseFloat(document.getElementById('weight').value)||75;
    const power = Math.max(0, weight*g*v*(slope/100));
    
    marker.setLatLng(coords[idx]);
    map.setView(coords[idx], map.getZoom());
    
    document.getElementById('slope').textContent = slope.toFixed(1);
    document.getElementById('hm').textContent = totalGain.toFixed(0);
    document.getElementById('power').textContent = power.toFixed(0);
    document.getElementById('cadence').textContent = cadence.toFixed(0);
    document.getElementById('distance').textContent = distance.toFixed(2);
    const sec = Math.floor((new Date()-startTime)/1000);
    document.getElementById('time').textContent = Math.floor(sec/60).toString().padStart(2,'0')+':'+(sec%60).toString().padStart(2,'0');
    document.getElementById('calories').textContent = (distance*35).toFixed(0);
    
    // RPM < 5 Abfrage
    if(rpm<5){ if(confirm("RPM zu niedrig. Training beenden?")){clearInterval(playInterval); showSummary(); return;} }
    
    idx++;
    drawProfile();
  },1000);
}

function showSummary(){
  const summary = `
    Distanz: ${distance.toFixed(2)} km
    Zeit: ${document.getElementById('time').textContent}
    Kalorien: ${document.getElementById('calories').textContent} kcal
    Höhenmeter: ${totalGain.toFixed(0)} m
    Leistung: ${document.getElementById('power').textContent} W
  `;
  alert(summary);
}

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000, toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

window.addEventListener('resize', drawProfile);
</script>
</body>
