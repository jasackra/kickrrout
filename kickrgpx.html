<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<title>Kickr Live Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body { height:100%; margin:0; padding:0; overflow:hidden; font-family: 'Segoe UI', sans-serif; }
  #controls {
    position:absolute; top:10px; left:10px; z-index:1000;
    background: rgba(255,255,255,0.95); padding:12px; border-radius:10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3); width:220px;
  }
  #controls input, #controls button { display:block; margin-top:6px; width:100%; padding:6px; font-size:14px; }
  #infoBar {
    position:absolute; top:10px; right:10px; z-index:1000;
    background: rgba(0,0,0,0.8); color:#fff; padding:10px; border-radius:10px;
    font-size:14px; line-height:1.5em; min-width:200px;
  }
  #map { width:100%; height:100%; }
  #profile {
    position:absolute; bottom:10px; left:10px; right:10px; height:120px; z-index:1000;
    background:#333; border-radius:10px; padding:5px;
  }
  #profile svg { width:100%; height:100%; }
  #popupEnd {
    position:absolute; top:15%; left:15%; width:70%; height:70%; z-index:2000;
    background: rgba(50,50,50,0.9); color:#fff; border-radius:12px; display:none;
    padding:20px; overflow:auto;
  }
  #fullscreenBtn {
    position:absolute; top:10px; right:240px; z-index:1000;
    background:#444; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;
  }
</style>
</head>
<body>

<div id="controls">
  <label>GPX-Datei (Pflicht)</label>
  <input type="file" id="gpxfile" accept=".gpx"/>
  <label>Fahrergewicht (kg, Pflicht)</label>
  <input type="number" id="weight" value="75" min="30" max="150"/>
  <button id="connectKickr">Kickr verbinden</button>
</div>

<div id="infoBar">
  <div>Distanz: <span id="distance">0</span> km</div>
  <div>Dauer: <span id="duration">0:00</span></div>
  <div>Höhenmeter: <span id="hm">0</span> m</div>
  <div>Steigung: <span id="slope">0</span> %</div>
  <div>Leistung: <span id="power">0</span> W</div>
  <div>Kadenz: <span id="cadence">0</span> rpm</div>
</div>

<div id="map"></div>

<div id="profile">
  <svg id="profileSVG"></svg>
</div>

<div id="popupEnd">
  <h2>Fahrt beendet</h2>
  <div id="summary"></div>
  <button onclick="closePopup()">Schließen</button>
</div>

<button id="fullscreenBtn">⛶ Vollbild</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

<script>
let map = L.map('map').setView([51.5,10],6);
let osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'&copy; OSM' }).addTo(map);

let routeLine=null, marker=null, coords=[], elevations=[];
let totalGain=0, idx=0, startTime=null, distance=0;

const g=9.81; 
let weight=75;
let cadence=0;

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000, toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

function updateMarker(i){
  if(!coords[i] || !coords[i+1]) return;
  marker.setLatLng(coords[i]);
  map.setView(coords[i], map.getZoom(), {animate:true, duration:0.25});
  const h1=elevations[i], h2=elevations[i+1];
  const dist = haversine(coords[i][0],coords[i][1],coords[i+1][0],coords[i+1][1]);
  distance += dist/1000;
  const slope = dist>0 ? ((h2-h1)/dist)*100 : 0;
  if(h2>h1) totalGain += (h2-h1);
  const power = Math.max(0, weight*g*dist*(slope/100));
  document.getElementById('distance').textContent = distance.toFixed(2);
  const elapsed = ((Date.now()-startTime)/1000)|0;
  document.getElementById('duration').textContent = Math.floor(elapsed/60)+":"+("0"+elapsed%60).slice(-2);
  document.getElementById('slope').textContent = slope.toFixed(1);
  document.getElementById('hm').textContent = totalGain.toFixed(0);
  document.getElementById('power').textContent = power.toFixed(0);
  document.getElementById('cadence').textContent = cadence;
  updateProfile(i);
}

function updateProfile(i){
  const svg = document.getElementById('profileSVG');
  svg.innerHTML='';
  const maxH = Math.max(...elevations);
  const minH = Math.min(...elevations);
  const w = svg.clientWidth, h = svg.clientHeight;
  let path='M';
  coords.forEach((c,j)=>{
    const x = j/(coords.length-1)*w;
    const y = h-(elevations[j]-minH)/(maxH-minH)*h;
    path += `${x},${y} `;
    if(j===i) path += `M${x},0 L${x},${h} `;
  });
  const line = document.createElementNS("http://www.w3.org/2000/svg",'path');
  line.setAttribute('d',path);
  line.setAttribute('stroke','blue');
  line.setAttribute('stroke-width','2');
  line.setAttribute('fill','none');
  svg.appendChild(line);
}

// Vollbild
document.getElementById('fullscreenBtn').addEventListener('click',()=>{
  const el=document.getElementById('map');
  if(!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.();
});

// GPX laden
document.getElementById('gpxfile').addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file)return;
  weight=parseFloat(document.getElementById('weight').value)||75;
  const reader=new FileReader();
  reader.onload=evt=>{
    try{
      const gpxDoc=new DOMParser().parseFromString(evt.target.result,"application/xml");
      const geo=toGeoJSON.gpx(gpxDoc);
      const feature = geo.features.find(f=>f.geometry?.type==="LineString");
      if(!feature){alert("Keine Trackdaten."); return;}
      coords = feature.geometry.coordinates.map(c=>[c[1],c[0]]);
      elevations = feature.geometry.coordinates.map(c=>c[2]||0);
      totalGain=0; idx=0; distance=0; startTime=Date.now();
      if(routeLine) map.removeLayer(routeLine);
      routeLine=L.polyline(coords,{color:'#00aaff',weight:4}).addTo(map);
      map.fitBounds(routeLine.getBounds());
      if(marker) map.removeLayer(marker);
      marker=L.marker(coords[0]).addTo(map);
    }catch(err){console.error(err); alert("Fehler beim Laden.");}
  };
  reader.readAsText(file);
});

// Kickr Verbindung (Web Bluetooth / FTMS)
let kickrDevice=null;
document.getElementById('connectKickr').addEventListener('click', async()=>{
  try{
    kickrDevice = await navigator.bluetooth.requestDevice({
      filters:[{namePrefix:'KICKR'}],
      optionalServices:['cycling_power','fitness_machine']
    });
    const server = await kickrDevice.gatt.connect();
    document.getElementById('connectKickr').textContent='Kickr verbunden';
    // Hier können Services subscriben für cadence, power etc.
  }catch(err){alert("Kickr Verbindung fehlgeschlagen"); console.error(err);}
});

// Popup End
function showPopup(){
  document.getElementById('summary').innerHTML=
    `Distanz: ${distance.toFixed(2)} km<br>
    Dauer: ${document.getElementById('duration').textContent}<br>
    Höhenmeter: ${totalGain.toFixed(0)} m<br>
    Leistung: ${document.getElementById('power').textContent} W`;
  document.getElementById('popupEnd').style.display='block';
}
function closePopup(){document.getElementById('popupEnd').style.display='none';}

// Simulationsschleife: nur wenn Kadenz>0
setInterval(()=>{
  if(coords.length && cadence>0){
    if(idx<coords.length-1){ updateMarker(idx); idx++; }
  }else if(idx>0 && cadence<5){ showPopup(); }
},200);

</script>
</body>
</html>
