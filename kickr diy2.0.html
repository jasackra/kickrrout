<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<title>Kickr Live Tracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body {height:100%; margin:0; padding:0; overflow:hidden;}
#map {width:100%; height:100vh;}
#controls {
  position:absolute; top:10px; left:10px; z-index:1000;
  background: rgba(255,255,255,0.8); padding:10px; border-radius:8px;
}
#controls input, #controls button {margin-top:4px;}
#themeBtn, #fullscreenBtn {
  background:#222; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:bold;
}
#themeBtn.light {background:#eee; color:#222;}
#stats {
  position:absolute; bottom:15px; left:15px; z-index:1000;
  background:rgba(0,0,0,0.7); color:#fff; font-family:sans-serif;
  padding:8px 12px; border-radius:8px; font-size:14px; line-height:1.4em;
}
</style>
</head>
<body>

<div id="controls">
  Fahrergewicht (kg): <input type="number" id="weight" value="75" min="30" max="150"/><br>
  <button id="themeBtn" class="light">ðŸŒž Tag</button><br>
  <button id="fullscreenBtn">â›¶ Vollbild</button><br>
  <button id="connectBtn">ðŸ”— KICKR CORE verbinden</button>
</div>

<div id="stats">
  Distanz: <span id="distance">0</span> km<br>
  Zeit: <span id="time">0:00</span><br>
  HÃ¶henmeter: <span id="hm">0</span> m<br>
  Steigung: <span id="slope">0</span> %<br>
  Leistung: <span id="power">0</span> W<br>
  Kadenz: <span id="cadence">0</span> rpm
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map = L.map('map').setView([51.5, 10],6);

const osmLight = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap contributors'});
const osmDark = L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {maxZoom:20, attribution:'&copy; OpenStreetMap & Stadia Maps'});
let currentLayer = osmLight.addTo(map);
let darkMode = false;

document.getElementById('themeBtn').addEventListener('click', () => {
  map.removeLayer(currentLayer);
  const btn = document.getElementById('themeBtn');
  if (darkMode) { currentLayer = osmLight.addTo(map); btn.textContent="ðŸŒž Tag"; btn.classList.add("light"); darkMode=false; }
  else { currentLayer = osmDark.addTo(map); btn.textContent="ðŸŒ™ Nacht"; btn.classList.remove("light"); darkMode=true; }
});

document.getElementById('fullscreenBtn').addEventListener('click', () => {
  const el = document.getElementById('map');
  if (!document.fullscreenElement) { if(el.requestFullscreen) el.requestFullscreen(); }
  else { if(document.exitFullscreen) document.exitFullscreen(); }
});

let marker=null, coords=[[51.5,10]], elevations=[0], idx=0, totalGain=0;
let distance=0, startTime=null, timer=null;
const g=9.81; 
let weight = parseFloat(document.getElementById('weight').value)||75;

function haversine(lat1,lon1,lat2,lon2){ const R=6371000, toRad=d=>d*Math.PI/180; const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(a)); }

function updateStats(lat, lon, elev, cad, power, dist){
  if(marker) marker.setLatLng([